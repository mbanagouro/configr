name: ConfigR CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  release:
    types: [published]

jobs:

  build-test:
    name: Build & Test
    runs-on: ubuntu-latest

    services:
      sqlserver:
        image: mcr.microsoft.com/mssql/server:2022-latest
        ports:
          - 1433:1433
        env:
          ACCEPT_EULA: "Y"
          SA_PASSWORD: "Pass@123"
        options: >-
          --health-cmd "/opt/mssql-tools18/bin/sqlcmd -S 127.0.0.1 -U sa -P 'Pass@123' -C -Q 'SELECT 1'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10

      mysql:
        image: mysql:8
        env:
          MYSQL_ROOT_PASSWORD: "123456"
          MYSQL_DATABASE: "configr_test"
        ports:
          - 3306:3306
        options: >-
          --health-cmd "mysqladmin ping -h localhost -p123456"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 10

      postgres:
        image: postgres:16
        env:
          POSTGRES_PASSWORD: "123456"
          POSTGRES_USER: "postgres"
          POSTGRES_DB: "configr_test"
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 5

      mongo:
        image: mongo:7
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.runCommand({ ping: 1 })'"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 5

      ravendb:
        image: ravendb/ravendb:6.0-ubuntu-latest
        ports:
          - 8080:8080
        env:
          RAVEN_Setup_Mode: "None"
          RAVEN_License_Eula_Accepted: "true"
          RAVEN_Security_UnsecuredAccessAllowed: "PublicNetwork"
        options: >-
          --health-cmd "curl -f http://localhost:8080 || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.x'

      - name: Restore
        run: dotnet restore

      - name: Wait for SQL Server
        run: |
          echo "Waiting SQL Server..."
          sleep 20

      - name: Wait for MySQL
        run: |
          echo "Waiting MySQL..."
          sleep 20

      - name: Wait for Npgsql
        run: |
          echo "Waiting PostgreSQL..."
          for i in {1..20}; do
            if PGPASSWORD=123456 psql -h localhost -U postgres -d configr_test -c "SELECT 1" &>/dev/null; then
              break
            fi
            sleep 2
          done

      - name: Wait for MongoDB
        run: |
          echo "Waiting MongoDB..."
          for i in {1..20}; do
            if mongosh "mongodb://localhost:27017" --eval "db.runCommand({ ping: 1 })" &>/dev/null; then
              break
            fi
            sleep 2
          done

      - name: Wait for Redis
        run: |
          echo "Waiting Redis..."
          sleep 20

      - name: Wait for RavenDB
        run: |
          echo "Waiting RavenDB..."
          for i in {1..30}; do
            if curl -sf http://localhost:8080 >/dev/null; then
              break
            fi
            sleep 2
          done

      - name: Test
        env:
          CONFIGR_TEST_SQL_CONN: "Server=localhost,1433;Database=ConfigR_Test;User Id=sa;Password=Pass@123;TrustServerCertificate=True;"
          CONFIGR_TEST_MYSQL_CONN: "Server=localhost;Port=3306;Database=configr_test;User=root;Password=123456;SslMode=None"
          CONFIGR_TEST_POSTGRES_CONN: "Host=localhost;Port=5432;Database=configr_test;Username=postgres;Password=123456;"
          CONFIGR_TEST_MONGO_CONN: "mongodb://localhost:27017"
          CONFIGR_TEST_REDIS_CONN: "localhost:6379"
          CONFIGR_TEST_RAVEN_URLS: "http://localhost:8080"
          CONFIGR_TEST_RAVEN_DB: "ConfigR_Test"
        run: dotnet test ./tests/ConfigR.Tests/ConfigR.Tests.csproj --configuration Debug --verbosity normal

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: "**/TestResults/**/*.trx"

  publish-nuget:
    name: Publish NuGet
    needs: build-test
    runs-on: ubuntu-latest
    if: github.event_name == 'release' && startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Restore
        run: dotnet restore

      - name: Pack Abstractions
        run: dotnet pack src/ConfigR.Abstractions/ConfigR.Abstractions.csproj -c Release -o ./nupkgs /p:PackageVersion=${GITHUB_REF#refs/tags/v}

      - name: Pack Core
        run: dotnet pack src/ConfigR.Core/ConfigR.Core.csproj -c Release -o ./nupkgs /p:PackageVersion=${GITHUB_REF#refs/tags/v}

      - name: Pack SQL Server Provider
        run: dotnet pack src/ConfigR.SqlServer/ConfigR.SqlServer.csproj -c Release -o ./nupkgs /p:PackageVersion=${GITHUB_REF#refs/tags/v}

      - name: Pack MySQL Provider
        run: dotnet pack src/ConfigR.MySql/ConfigR.MySql.csproj -c Release -o ./nupkgs /p:PackageVersion=${GITHUB_REF#refs/tags/v}

      - name: Pack Npgsql Provider
        run: dotnet pack src/ConfigR.Npgsql/ConfigR.Npgsql.csproj -c Release -o ./nupkgs /p:PackageVersion=${GITHUB_REF#refs/tags/v}

      - name: Pack MongoDB Provider
        run: dotnet pack src/ConfigR.MongoDB/ConfigR.MongoDB.csproj -c Release -o ./nupkgs /p:PackageVersion=${GITHUB_REF#refs/tags/v}

      - name: Pack Redis Provider
        run: dotnet pack src/ConfigR.Redis/ConfigR.Redis.csproj -c Release -o ./nupkgs /p:PackageVersion=${GITHUB_REF#refs/tags/v}

      - name: Pack RavenDB Provider
        run: dotnet pack src/ConfigR.RavenDB/ConfigR.RavenDB.csproj -c Release -o ./nupkgs /p:PackageVersion=${GITHUB_REF#refs/tags/v}

      - name: Publish to NuGet
        run: dotnet nuget push "./nupkgs/*.nupkg" --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json
